# PostgreSQL Initialization Scripts

This directory contains SQL scripts that are automatically executed by PostgreSQL when the database is **first initialized** (i.e., when the `postgres_data` volume is empty).

## How It Works

- PostgreSQL executes `.sql` and `.sh` files in this directory in **alphabetical order**
- Scripts only run during **initial database creation**
- If the database already exists, these scripts are **ignored**

## Recommended: Use pgloader for Migration

For production-to-dev migrations, use the **pgloader method** instead of SQL files:

```bash
./run-migration.sh
```

See `MIGRATION.md` for full details. This method:
- ✅ Automatically handles MySQL→PostgreSQL conversion
- ✅ No intermediate SQL files needed
- ✅ Direct database-to-database copy
- ✅ Better error handling

## Alternative: SQL File Migration

For sampled/anonymized migrations, use the SQL dump method:

1. **Generate migration from production:**
   ```bash
   ./create-dev-sql-dump.sh
   ```
   This creates `dev_migration.sql` (MariaDB/MySQL format)

2. **Convert to PostgreSQL format:**
   ```bash
   ./prepare-migration.sh
   ```
   This converts and places the file as `01-migration.sql` in this directory

3. **Reset database and reload:**
   ```bash
   docker compose down -v    # Removes ALL volumes including database
   docker compose up -d      # Starts fresh, runs init scripts
   ```

**Note:** The SQL conversion is basic. For complex migrations, use pgloader instead.

## Important Notes

- **Numbered Prefixes**: Use numeric prefixes (01-, 02-, etc.) to control execution order
- **One-Time Execution**: Scripts only run on first initialization
- **Volume Reset Required**: To re-run scripts, you must delete the `postgres_data` volume
- **Check Logs**: Monitor initialization with `docker compose logs postgres`

## File Naming Convention

- `01-migration.sql` - Main data migration (auto-generated by prepare-migration.sh)
- `02-custom.sql` - Your custom SQL (if needed)
- `99-final.sql` - Final setup steps (if needed)
